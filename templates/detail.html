<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scan Details â€¢ SecureScanX</title>

    <!-- Bootstrap + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Poppins Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

        body {
            background: linear-gradient(135deg, #6a11cb 0%, #a855f7 35%, #55a3ff 70%, #00c9a7 100%);
            background-size: 400% 400%;
            animation: gradientShift 12s ease infinite;
            min-height: 100vh;
            font-family: 'Poppins', sans-serif;
            color: white;
            margin: 0;
            padding: 0;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Glassmorphic Cards */
        .card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            height: 100%;
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: white;
        }

        .btn-action {
            background: linear-gradient(45deg, #00c9a7, #55a3ff);
            border: none;
            border-radius: 12px;
            padding: 0.6rem 1.2rem;
            font-weight: 600;
            color: white;
            transition: all 0.4s ease;
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 201, 167, 0.4);
            color: white;
        }

        .list-group-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .list-group-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .badge {
            font-size: 0.8rem;
            padding: 0.4em 0.8em;
        }

        .text-muted-light {
            color: rgba(255, 255, 255, 0.7) !important;
        }

        /* Table */
        .table {
            color: #000;
            background: rgba(255, 255, 255, 0.9);
        }

        .table th {
            background: linear-gradient(90deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            font-weight: 600;
        }

        .table td {
            border-color: rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.9);
        }

        /* Badges */
        .badge-critical { background: linear-gradient(135deg, #ff0844, #ffb199); color: white; }
        .badge-high     { background: linear-gradient(135deg, #ff6b6b, #feca57); color: white; }
        .badge-medium   { background: linear-gradient(135deg, #feca57, #ff9ff3); color: white; }
        .badge-low      { background: linear-gradient(135deg, #48dbfb, #1dd1a1); color: white; }
        .badge-info     { background: #17a2b8; color: white; }

        /* Charts */
        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .gradient-text {
            color: white;
            font-weight: 700;
        }

        .text-cyan {
            color: #000 !important;
        }
        .text-cyan:hover {
            color: #6a11cb !important;
        }
    </style>
</head>
<body>

    <!-- Optional: Navbar (same as dashboard) -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-shield-alt me-2"></i> SecureScanX
            </a>
            <div class="d-flex align-items-center">
                <span class="nav-info me-3">
                    <i class="fas fa-building me-1"></i> {{ session.company }}
                </span>
                <span class="nav-info me-3">
                    <i class="fas fa-user me-1"></i> {{ session.username }}
                </span>
                <a href="{{ url_for('user.logout') }}" class="nav-link">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">

        <!-- Header -->
        <div class="text-center mb-5">
            <h1 class="display-5 gradient-text">Scan Report</h1>
            <p class="lead text-muted-light">Detailed vulnerability analysis</p>
        </div>

        <!-- Scan Info Card -->
        <div class="card mb-5">
            <div class="card-body">
                <div class="row text-center text-md-start">
                    <div class="col-md-6">
                        <h5 style="color: white;">Target URL</h5>
                        <p class="fs-4 gradient-text">{{ scan.url }}</p>
                    </div>
                    <div class="col-md-3">
                        <h5 style="color: white;">Scanned On</h5>
                        <p class="text-light">{{ scan.timestamp }}</p>
                    </div>
                    <div class="col-md-3">
                        <h5 style="color: white;">Mode</h5>
                        <span class="badge bg-info fs-6">{{ scan.mode|capitalize }}</span>
                    </div>
                </div>
                <hr class="border-light opacity-25"/>
                <div class="text-center">
                    <a href="{{ url_for('report', scan_id=scan.scan_key) }}" class="btn btn-action me-2">
                        <i class="fas fa-file-pdf me-2"></i>Download PDF
                    </a>
                    <a href="{{ url_for('download_json', scan_id=scan.scan_key) }}" class="btn btn-action">
                        <i class="fas fa-file-code me-2"></i>Download JSON
                    </a>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row g-4 mb-5">
            <div class="col-lg-4">
                <div class="chart-container">
                    <h5 class="text-center gradient-text mb-3">Severity Distribution</h5>
                    <canvas id="severityChart"></canvas>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="chart-container">
                    <h5 class="text-center gradient-text mb-3">Finding Source</h5>
                    <canvas id="sourceChart"></canvas>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="chart-container">
                    <h5 class="text-center gradient-text mb-3">Risk Score</h5>
                    <canvas id="riskChart"></canvas>
                </div>
            </div>
        </div>


        <!-- ZAP Findings -->
        {% if zap_results %}
        <div class="card mb-4">
            <div class="card-header text-white" style="background: linear-gradient(90deg, #6a11cb, #2575fc);">
                <h4 class="mb-0">ZAP Findings ({{ zap_results|length }})</h4>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Vulnerability</th>
                                <th>Severity</th>
                                <th>URL</th>
                                <th>Mitigation</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for alert in zap_results %}
                            <tr>
                                <td><code style="color: #000;">{{ alert.type }}</code></td>
                                <td>
                                    <span class="badge
                                        {% if 'high' in alert.severity|lower %}badge-high
                                        {% elif 'medium' in alert.severity|lower %}badge-medium
                                        {% elif 'low' in alert.severity|lower %}badge-low
                                        {% elif 'info' in alert.severity|lower %}badge-info
                                        {% else %}badge-critical{% endif %} px-3 py-1">
                                        {{ alert.severity }}
                                    </span>
                                </td>
                                <td>
                                    <a href="{{ alert.url }}" target="_blank" class="text-decoration-none text-cyan">
                                        {{ alert.url[:50] }}{% if alert.url|length > 50 %}...{% endif %}
                                    </a>
                                </td>
                                <td>
                                    <small class="mitigation-text" data-vuln="{{ alert.type }}" style="color: #000;">
                                        <i class="fas fa-spinner fa-spin me-1"></i>Loading...
                                    </small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-success border-0" style="background: rgba(40, 167, 69, 0.2);">
            No ZAP vulnerabilities detected.
        </div>
        {% endif %}

        <!-- Nuclei Findings -->
        {% if nuclei_results %}
        <div class="card">
            <div class="card-header text-white" style="background: linear-gradient(90deg, #2575fc, #00c9a7);">
                <h4 class="mb-0">Nuclei Findings ({{ nuclei_results|length }})</h4>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Template</th>
                                <th>Severity</th>
                                <th>Matched URL</th>
                                <th>Name</th>
                                <th>Mitigation</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in nuclei_results %}
                            <tr>
                                <td><code style="color: #000;">{{ item.template }}</code></td>
                                <td>
                                    <span class="badge
                                        {% if item.severity == 'critical' %}badge-critical
                                        {% elif item.severity == 'high' %}badge-high
                                        {% elif item.severity == 'medium' %}badge-medium
                                        {% elif item.severity == 'low' %}badge-low
                                        {% else %}badge-info{% endif %} px-3 py-1">
                                        {{ item.severity|capitalize }}
                                    </span>
                                </td>
                                <td>
                                    <a href="{{ item.matched }}" target="_blank" class="text-decoration-none text-cyan">
                                        {{ item.matched[:50] }}{% if item.matched|length > 50 %}...{% endif %}
                                    </a>
                                </td>
                                <td>{{ item.name }}</td>
                                <td>
                                    <small class="mitigation-text" data-vuln="{{ item.name }}" style="color: #000;">
                                        <i class="fas fa-spinner fa-spin me-1"></i>Loading...
                                    </small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-success border-0 mt-3" style="background: rgba(40, 167, 69, 0.2);">
            No Nuclei vulnerabilities detected.
        </div>
        {% endif %}

    </div>

    <!-- Chart.js -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const zap = {{ zap_results|tojson }};
            const nuclei = {{ nuclei_results|tojson }};
            const scanId = {{ scan.scan_key }};

            // Fetch mitigations from API
            fetch(`/api/mitigation/${scanId}`)
                .then(response => response.json())
                .then(data => {
                    const mitigations = data.mitigations;
                    console.log('Mitigations loaded:', data.cached ? 'from cache' : 'from Gemini');

                    // Update all mitigation text elements
                    document.querySelectorAll('.mitigation-text').forEach(element => {
                        const vulnName = element.getAttribute('data-vuln');
                        const mitigation = mitigations[vulnName] || 'Update software, apply patches, review configuration, and follow security best practices.';
                        element.innerHTML = `<i class="fas fa-shield-alt me-1"></i>${mitigation}`;
                    });
                })
                .catch(error => {
                    console.error('Error fetching mitigations:', error);
                    // Show error message
                    document.querySelectorAll('.mitigation-text').forEach(element => {
                        element.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Error loading mitigation';
                    });
                });

            const severityCount = { critical: 0, high: 0, medium: 0, low: 0, info: 0 };

            zap.forEach(a => {
                const s = a.severity.toLowerCase();
                if (s.includes('high')) severityCount.high++;
                else if (s.includes('medium')) severityCount.medium++;
                else if (s.includes('low')) severityCount.low++;
                else if (s.includes('info')) severityCount.info++;
                else severityCount.critical++;
            });

            nuclei.forEach(n => {
                const s = n.severity.toLowerCase();
                if (s === 'critical') severityCount.critical++;
                else if (s === 'high') severityCount.high++;
                else if (s === 'medium') severityCount.medium++;
                else if (s === 'low') severityCount.low++;
                else severityCount.info++;
            });

            // Doughnut Chart
            new Chart(document.getElementById('severityChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Critical', 'High', 'Medium', 'Low', 'Info'],
                    datasets: [{
                        data: [severityCount.critical, severityCount.high, severityCount.medium, severityCount.low, severityCount.info],
                        backgroundColor: ['#ff0844', '#ff6b6b', '#feca57', '#48dbfb', '#17a2b8'],
                        borderWidth: 2,
                        borderColor: 'rgba(255,255,255,0.2)'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: 'white' } },
                        tooltip: { backgroundColor: 'rgba(0,0,0,0.7)', titleColor: '#fff', bodyColor: '#ddd' }
                    }
                }
            });

            // Source Distribution (ZAP vs Nuclei)
            new Chart(document.getElementById('sourceChart'), {
                type: 'pie',
                data: {
                    labels: ['ZAP', 'Nuclei'],
                    datasets: [{
                        data: [zap.length, nuclei.length],
                        backgroundColor: ['#2575fc', '#00c9a7'],
                        borderWidth: 2,
                        borderColor: 'rgba(255,255,255,0.2)'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: 'white' } },
                        tooltip: { backgroundColor: 'rgba(0,0,0,0.7)', titleColor: '#fff', bodyColor: '#ddd' }
                    }
                }
            });

            // Risk Score Gauge
            const riskScore = Math.min(100, (severityCount.critical * 10) + (severityCount.high * 5) + (severityCount.medium * 2) + severityCount.low);
            new Chart(document.getElementById('riskChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Risk', 'Safe'],
                    datasets: [{
                        data: [riskScore, Math.max(0, 100 - riskScore)],
                        backgroundColor: ['#ff0844', '#1dd1a1'],
                        borderWidth: 0,
                        circumference: 180,
                        rotation: 270
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                        title: {
                            display: true,
                            text: riskScore + ' / 100',
                            color: 'white',
                            font: { size: 24, weight: 'bold' },
                            padding: { top: 20 }
                        }
                    }
                }
            });

        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>